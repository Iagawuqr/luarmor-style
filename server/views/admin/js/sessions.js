const Sessions={
sessions:[],
refreshInterval:null,
autoRefresh:false,
async init(){await this.load();this.bindEvents();this.startAutoRefresh()},
async load(){const r=await API.get('/api/admin/sessions');if(r.success){this.sessions=r.sessions||[];this.renderTable()}else{Utils.toast('Failed to load sessions','error')}},
renderTable(){const tbody=document.getElementById('sessionsTableBody');if(!tbody)return;document.getElementById('sessionCount').textContent=this.sessions.length;if(this.sessions.length===0){tbody.innerHTML=`<tr><td colspan="7" class="text-center" style="padding:40px"><div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><h4>No active sessions</h4><p class="text-muted">Users will appear here when they load your script</p></div></td></tr>`;return}tbody.innerHTML=this.sessions.map(s=>`<tr class="animate-fadeIn"><td><code class="text-primary" title="${s.sessionId}">${s.sessionId.substring(0,8)}...</code></td><td><span class="badge badge-info">${s.userId||'N/A'}</span></td><td><code class="text-muted" title="${s.hwid||''}">${(s.hwid||'N/A').substring(0,12)}${s.hwid&&s.hwid.length>12?'...':''}</code></td><td><code class="text-sm">${s.ip||'N/A'}</code></td><td><span class="badge badge-purple">${s.placeId||'N/A'}</span></td><td><span class="badge ${s.age<300?'badge-success':s.age<900?'badge-warning':'badge-danger'}">${this.formatAge(s.age)}</span></td><td><div class="table-actions"><button class="btn btn-warning btn-sm btn-icon" onclick="Sessions.suspendSession('${s.sessionId}')" title="Suspend">â¸ï¸</button><button class="btn btn-danger btn-sm btn-icon" onclick="Sessions.killSession('${s.sessionId}')" title="Kill">ğŸ’€</button><button class="btn btn-ghost btn-sm btn-icon" onclick="Sessions.viewDetails('${s.sessionId}')" title="Details">ğŸ‘ï¸</button></div></td></tr>`).join('')},
formatAge(seconds){if(seconds<60)return`${seconds}s`;if(seconds<3600)return`${Math.floor(seconds/60)}m`;return`${Math.floor(seconds/3600)}h ${Math.floor((seconds%3600)/60)}m`},
bindEvents(){const toggle=document.getElementById('sessionsAutoRefresh');if(toggle)toggle.addEventListener('change',e=>this.toggleAutoRefresh(e.target.checked))},
startAutoRefresh(){if(this.autoRefresh)this.refreshInterval=setInterval(()=>this.load(),10000)},
stopAutoRefresh(){if(this.refreshInterval){clearInterval(this.refreshInterval);this.refreshInterval=null}},
toggleAutoRefresh(enabled){this.autoRefresh=enabled;if(enabled){this.startAutoRefresh();Utils.toast('Auto-refresh enabled','info')}else{this.stopAutoRefresh();Utils.toast('Auto-refresh disabled','info')}},
async refresh(){const btn=document.querySelector('.refresh-sessions-btn');if(btn)btn.classList.add('animate-spin');await this.load();if(btn)setTimeout(()=>btn.classList.remove('animate-spin'),500);Utils.toast('Sessions refreshed','success')},
async killSession(sessionId){const ok=await Utils.confirm('Kill this session immediately?','Kill Session');if(!ok)return;const r=await API.post('/api/admin/kill-session',{sessionId,reason:'Killed by admin'});if(r.success){Utils.toast('Session will be terminated','success');this.load()}else{Utils.toast(r.error||'Failed','error')}},
async suspendSession(sessionId){const session=this.sessions.find(s=>s.sessionId===sessionId);if(!session)return;document.getElementById('suspendType').value='session';document.getElementById('suspendValue').value=sessionId;document.getElementById('suspendUserId').textContent=session.userId||'N/A';document.getElementById('suspendHwid').textContent=(session.hwid||'N/A').substring(0,16);document.getElementById('addSuspendModal').classList.add('active')},
async killAll(){const ok=await Utils.confirm(`Kill all ${this.sessions.length} active sessions?`,'Kill All Sessions');if(!ok)return;const r=await API.post('/api/admin/sessions/clear');if(r.success){Utils.toast(`Killed ${r.cleared} sessions`,'success');this.load()}else{Utils.toast(r.error||'Failed','error')}},
viewDetails(sessionId){const s=this.sessions.find(x=>x.sessionId===sessionId);if(!s)return;const content=`<div class="info-list"><div class="info-item"><span class="info-label">Session ID</span><span class="info-value">${s.sessionId}</span></div><div class="info-item"><span class="info-label">User ID</span><span class="info-value">${s.userId||'N/A'}</span></div><div class="info-item"><span class="info-label">HWID</span><span class="info-value">${s.hwid||'N/A'}</span></div><div class="info-item"><span class="info-label">IP Address</span><span class="info-value">${s.ip||'N/A'}</span></div><div class="info-item"><span class="info-label">Place ID</span><span class="info-value">${s.placeId||'N/A'}</span></div><div class="info-item"><span class="info-label">Created</span><span class="info-value">${new Date(s.created).toLocaleString()}</span></div><div class="info-item"><span class="info-label">Last Seen</span><span class="info-value">${new Date(s.lastSeen).toLocaleString()}</span></div><div class="info-item"><span class="info-label">Age</span><span class="info-value">${this.formatAge(s.age)}</span></div></div>`;document.getElementById('sessionDetailsContent').innerHTML=content;document.getElementById('sessionDetailsModal').classList.add('active')},
closeDetailsModal(){document.getElementById('sessionDetailsModal').classList.remove('active')},
destroy(){this.stopAutoRefresh()},
render(){return`<div class="page-header"><div><h1 class="page-title">Active Sessions</h1><p class="page-subtitle">Monitor and control all active script sessions</p></div><div class="header-stats"><span class="badge badge-success" style="font-size:14px;padding:8px 16px">ğŸ‘¥ <span id="sessionCount">0</span> Active</span></div></div><div class="card animate-fadeInUp"><div class="card-header"><div class="actions-left"><label class="toggle-label"><input type="checkbox" id="sessionsAutoRefresh" class="toggle-input"><span class="toggle-switch"></span><span class="text-sm text-secondary">Auto-refresh (10s)</span></label></div><div class="actions-right"><button class="btn btn-secondary refresh-sessions-btn" onclick="Sessions.refresh()">â†» Refresh</button><button class="btn btn-danger" onclick="Sessions.killAll()">ğŸ’€ Kill All</button></div></div><div class="table-container"><table class="table"><thead><tr><th>Session</th><th>User ID</th><th>HWID</th><th>IP</th><th>Place</th><th>Age</th><th>Actions</th></tr></thead><tbody id="sessionsTableBody"><tr><td colspan="7" class="text-center" style="padding:40px"><div class="spinner"></div></td></tr></tbody></table></div></div><div class="modal-overlay" id="sessionDetailsModal"><div class="modal" style="max-width:500px"><div class="modal-header"><h3 class="modal-title">ğŸ“‹ Session Details</h3><button class="modal-close" onclick="Sessions.closeDetailsModal()">âœ•</button></div><div class="modal-body" id="sessionDetailsContent"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="Sessions.closeDetailsModal()">Close</button></div></div></div>`}
};
